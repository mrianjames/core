<script language="javascript" type="text/javascript" src="js/plugins/flot/jquery.flot.crosshair.min.js"></script>
<div id="${chart_id}" style="width:600px;height:300px"></div>
<div class='flot-x-axis flot-x1-axis'>
    <div class='flot-tick-label'>Time</div>
</div>
<div class='flot-y-axis flot-y1-axis'>
    <div class='flot-tick-label'>MB</div>
</div>
<script type="text/javascript">
		$(function() {
		    xformatter = function(val, axis){
		    	var num = Number(val);
		    	val = parseInt(num / 1024/1024);
			    val += '';
	            x = val.split('.');
	            x1 = x[0];
	            x2 = x.length > 1 ? '.' + x[1] : '';
	            var rgx = /(\d+)(\d{3})/;
	            while (rgx.test(x1)) {
	                x1 = x1.replace(rgx, '$1' + ',' + '$2');
	            }
	            return x1 + x2;
            };

			var options = {
		        legend:{         
		            backgroundOpacity: 0.2,
		            noColumns: 4
		            
		        },
		        series: {
                     lines: { show: true },
                     points: { show: false }
                },
		        crosshair: {
                                mode: "x"
                        },
                        grid: {
                                hoverable: true,
                                autoHighlight: false
                        },
		        xaxis: {
                    mode: "time",
                    timezone: "browser",
                    minTickSize: [1, "minute"],
                    twelveHourClock: false

                },
                yaxis: {
                    min: 0,
                    //max: 350000000,
                    tickFormatter: xformatter
                }
		    };
	    
			var d1 = [${chart_data1}];
			var d2 = [${chart_data2}];
			var d3 = [${chart_data3}];
			var d4 = [${chart_data4}];



			plot = $.plot("#${chart_id}", [ {label:"${chart_dataset_name1} = 0.0",data:d1},{label:"${chart_dataset_name2}=0.0",data:d2},{label:"${chart_dataset_name3}=0.0",data:d3},{label:"${chart_dataset_name4}=0.0",data:d4}],options );

			var legends = $("#${chart_id} .legendLabel");

                legends.each(function () {
                        // fix the widths so they don't jump around
                        $(this).css('width', $(this).width());
                });

                var updateLegendTimeout = null;
                var latestPosition = null;

                function updateLegend() {


                        updateLegendTimeout = null;

                        var pos = latestPosition;

                        var axes = plot.getAxes();
                        console.log("MY pos...["+pos.x+"] ["+pos.y+"] xmin: "+axes.xaxis.min+" xmax: "+axes.xaxis.max+" ymin: "+axes.yaxis.min+" ymax: "+axes.yaxis.max);

                        //alert("Updating..."+pos.x+"."+pos.y+" xmin: "+axes.xaxis.min+" xmax: "+axes.xaxis.max+" ymin: "+axes.yaxis.min+" ymax: "+axes.yaxis.max);
                        if (pos.x < axes.xaxis.min || pos.x > axes.xaxis.max ||
                                pos.y < axes.yaxis.min || pos.y > axes.yaxis.max) {
                                return;
                        }
                        console.log("Within bounds");
                        var i, j, dataset = plot.getData();
                        for (i = 0; i < dataset.length; ++i) {
                                var series = dataset[i];
                                if (series.data.length > 0) {

                                    // Find the nearest points, x-wise

                                    for (j = 0; j < series.data.length; ++j) {
                                            if (series.data[j][0] > pos.x) {
                                                    break;
                                            }
                                    }

                                    // Now Interpolate
                                    var y,
                                            p1 = series.data[j - 1],
                                            p2 = series.data[j];

                                    if (p1 == null) {
                                            y = p2[1];
                                    } else if (p2 == null) {
                                            y = p1[1];
                                    } else {
                                            y = p1[1] + (p2[1] - p1[1]) * (pos.x - p1[0]) / (p2[0] - p1[0]);
                                    }

                                    legends.eq(i).text(series.label.replace(/=.*/, "= " + y.toFixed(2)));
                                }
                        }
                }

                $("#${chart_id}").bind("plothover",  function (event, pos, item) {
                        latestPosition = pos;
                        if (!updateLegendTimeout) {
                                updateLegendTimeout = setTimeout(updateLegend, 50);
                        }
                });



		});

	</script>